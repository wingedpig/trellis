// Copyright Â© 2026 Groups.io, Inc.
// SPDX-License-Identifier: Apache-2.0

{% import "github.com/wingedpig/trellis/internal/cases" %}
{% import "github.com/wingedpig/trellis/internal/claude" %}
{% import "github.com/wingedpig/trellis/internal/terminal" %}

{% code
type WorktreeHomePage struct {
    BasePage
    WorktreeName    string
    Branch          string
    Cases           []cases.CaseInfo
    ClaudeSessions  []*claude.SessionInfo
    Terminals       []terminal.WindowInfo
    TmuxSessionName string // Empty if no tmux session exists
}
%}

{% func (p *WorktreeHomePage) Render() %}
{%= p.Header() %}

<link href="/static/css/worktree_home.css" rel="stylesheet">
<link href="/static/css/cases.css" rel="stylesheet">

<div class="worktree-home">
    <div class="worktree-header mb-4">
        <h2><i class="fa-solid fa-folder-tree"></i> {%s p.WorktreeName %}</h2>
        {% if p.Branch != "" %}
        <span class="badge bg-secondary"><i class="fa-solid fa-code-branch"></i> {%s p.Branch %}</span>
        {% endif %}
    </div>

    <!-- Cases -->
    <div class="section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fa-solid fa-briefcase"></i> Cases</h4>
            <div>
                <button class="btn btn-outline-secondary btn-sm me-1" id="showArchivedBtn" onclick="toggleArchivedCases()">
                    <i class="fa-solid fa-box-archive"></i> Show Archived
                </button>
                <button class="btn btn-primary btn-sm" onclick="showNewCaseModal()">
                    <i class="fa-solid fa-plus"></i> New Case
                </button>
            </div>
        </div>

        {% if len(p.Cases) == 0 %}
        <div class="empty-state" id="casesEmptyState">
            <p class="text-muted">No open cases. Create one to track a unit of work.</p>
        </div>
        {% else %}
        <div class="list-group" id="casesList">
            {% for _, c := range p.Cases %}
            <div class="list-group-item case-list-item">
                <div class="case-info">
                    <a href="/case/{%s p.WorktreeName %}/{%s c.ID %}" class="text-decoration-none">
                        <span class="badge case-kind-{%s c.Kind %} me-1">{%s c.Kind %}</span>
                        {%s c.Title %}
                    </a>
                    <span class="case-date">{%s c.CreatedAt.Format("2006-01-02") %}</span>
                </div>
                <button class="btn btn-outline-warning btn-sm" onclick="archiveCaseFromList('{%s JSAttr(c.ID) %}')">
                    <i class="fa-solid fa-box-archive"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div id="archivedCasesContainer" style="display:none;" class="mt-3">
            <h6 class="text-muted">Archived</h6>
            <div id="archivedCasesList" class="list-group"></div>
        </div>
    </div>

    <!-- Claude Sessions -->
    <div class="section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fa-solid fa-robot"></i> Claude Sessions</h4>
            <div>
                <button class="btn btn-outline-secondary btn-sm me-1" id="showTrashBtn" onclick="toggleTrashedSessions()">
                    <i class="fa-solid fa-trash-can"></i> Show Trash
                </button>
                <button class="btn btn-outline-secondary btn-sm me-1" onclick="showImportTranscriptModal()">
                    <i class="fa-solid fa-file-import"></i> Import Transcript
                </button>
                <button class="btn btn-primary btn-sm" onclick="showNewClaudeModal()">
                    <i class="fa-solid fa-plus"></i> New Session
                </button>
            </div>
        </div>

        {% if len(p.ClaudeSessions) == 0 %}
        <div class="empty-state">
            <p class="text-muted">No Claude sessions yet. Create one to get started.</p>
        </div>
        {% else %}
        <div class="list-group">
            {% for _, sess := range p.ClaudeSessions %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <a href="/claude/{%s p.WorktreeName %}/{%s sess.ID %}" class="text-decoration-none flex-grow-1 d-flex align-items-center">
                    <i class="fa-solid fa-message"></i>
                    <span class="ms-1">{%s sess.DisplayName %}</span>
                    {% if !sess.LastUserInput.IsZero() %}
                    <span class="text-muted ms-2 small">{%s FormatRelativeTime(sess.LastUserInput) %}</span>
                    {% endif %}
                </a>
                <button class="btn btn-outline-secondary btn-sm me-1" onclick="renameClaudeSession('{%s JSAttr(sess.ID) %}', '{%s JSAttr(sess.DisplayName) %}')">
                    <i class="fa-solid fa-pencil"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteClaudeSession('{%s JSAttr(sess.ID) %}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div id="trashedSessionsContainer" style="display:none;" class="mt-3">
            <h6 class="text-muted">Trash</h6>
            <div id="trashedSessionsList" class="list-group"></div>
        </div>
    </div>

    <!-- Terminals -->
    <div class="section mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fa-solid fa-terminal"></i> Terminals</h4>
            <button class="btn btn-primary btn-sm" onclick="showNewTerminalModal()">
                <i class="fa-solid fa-plus"></i> New Terminal
            </button>
        </div>

        {% if len(p.Terminals) == 0 %}
        <div class="empty-state">
            <p class="text-muted">No terminal windows. Create one to get started.</p>
        </div>
        {% else %}
        <div class="list-group">
            {% for _, win := range p.Terminals %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <a href="/terminal/local/{%s p.WorktreeName %}/{%s win.Name %}" class="text-decoration-none flex-grow-1">
                    <i class="fa-solid fa-terminal"></i>
                    {%s win.Name %}
                </a>
                <button class="btn btn-outline-secondary btn-sm me-1" onclick="renameTerminal('{%s JSAttr(win.Name) %}')">
                    <i class="fa-solid fa-pencil"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteTerminal('{%s JSAttr(win.Name) %}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

</div>

<!-- New Claude Session Modal -->
<div class="modal fade" id="newClaudeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-robot"></i> New Claude Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="claudeSessionName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="claudeSessionName" placeholder="Session 1" autofocus>
                    <div class="form-text">Leave blank for auto-naming (Session 1, Session 2, ...)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createClaudeSession()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- New Terminal Modal -->
<div class="modal fade" id="newTerminalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-terminal"></i> New Terminal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="terminalName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="terminalName" placeholder="shell" autofocus>
                    <div class="form-text">Leave blank for auto-naming (shell, shell-2, ...)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTerminal()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="renameModalTitle">Rename</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="renameInput">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="renameConfirmBtn">Rename</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Transcript Modal -->
<div class="modal fade" id="importTranscriptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-file-import"></i> Import Claude Transcript</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="transcriptFile" class="form-label">Transcript file (.json)</label>
                    <input type="file" class="form-control" id="transcriptFile" accept=".json">
                    <div class="form-text">Select a trellis.transcript.v1 JSON file exported from another session.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importTranscript()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- New Case Modal -->
<div class="modal fade" id="newCaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-briefcase"></i> New Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="caseTitle" class="form-label">Title</label>
                    <input type="text" class="form-control" id="caseTitle" placeholder="Investigate login timeout" autofocus>
                </div>
                <div class="mb-3">
                    <label for="caseKind" class="form-label">Kind</label>
                    <select class="form-select" id="caseKind">
                        <option value="task">Task</option>
                        <option value="bug">Bug</option>
                        <option value="feature">Feature</option>
                        <option value="investigation">Investigation</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCase()">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
const WORKTREE_NAME = '{%s JSAttr(p.WorktreeName) %}';

let newTerminalModal, newClaudeModal, newCaseModal, renameModal, importTranscriptModal;
let renameConfirmCallback = null;
document.addEventListener('DOMContentLoaded', function() {
    importTranscriptModal = new bootstrap.Modal(document.getElementById('importTranscriptModal'));

    newCaseModal = new bootstrap.Modal(document.getElementById('newCaseModal'));
    document.getElementById('newCaseModal').addEventListener('shown.bs.modal', function() {
        document.getElementById('caseTitle').focus();
    });
    document.getElementById('caseTitle').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); createCase(); }
    });
    newClaudeModal = new bootstrap.Modal(document.getElementById('newClaudeModal'));
    document.getElementById('newClaudeModal').addEventListener('shown.bs.modal', function() {
        document.getElementById('claudeSessionName').focus();
    });
    document.getElementById('claudeSessionName').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); createClaudeSession(); }
    });

    newTerminalModal = new bootstrap.Modal(document.getElementById('newTerminalModal'));
    document.getElementById('newTerminalModal').addEventListener('shown.bs.modal', function() {
        document.getElementById('terminalName').focus();
    });
    document.getElementById('terminalName').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); createTerminal(); }
    });

    renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    document.getElementById('renameModal').addEventListener('shown.bs.modal', function() {
        const input = document.getElementById('renameInput');
        input.focus();
        input.select();
    });
    document.getElementById('renameInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); document.getElementById('renameConfirmBtn').click(); }
    });
    document.getElementById('renameConfirmBtn').addEventListener('click', function() {
        if (renameConfirmCallback) renameConfirmCallback();
    });
});

function showNewClaudeModal() {
    document.getElementById('claudeSessionName').value = '';
    newClaudeModal.show();
}

function showNewTerminalModal() {
    document.getElementById('terminalName').value = '';
    newTerminalModal.show();
}

function createClaudeSession() {
    const name = document.getElementById('claudeSessionName').value.trim();
    const body = name ? JSON.stringify({display_name: name}) : '{}';
    fetch('/api/v1/claude/' + encodeURIComponent(WORKTREE_NAME) + '/sessions', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: body
    })
    .then(r => {
        if (!r.ok) return r.json().then(d => { throw new Error(d.error?.message || 'Create failed'); });
        return r.json();
    })
    .then(data => {
        const sess = data.data || data;
        TrellisNav.pushToHistory(window.location.pathname);
        window.location.href = '/claude/' + encodeURIComponent(WORKTREE_NAME) + '/' + sess.id;
    })
    .catch(err => alert('Failed to create session: ' + err));
}

function deleteClaudeSession(sessionId) {
    fetch('/api/v1/claude/sessions/' + sessionId, { method: 'DELETE' })
    .then(() => window.location.reload())
    .catch(err => alert('Failed to trash session: ' + err));
}

let trashedVisible = false;
function toggleTrashedSessions() {
    const container = document.getElementById('trashedSessionsContainer');
    const btn = document.getElementById('showTrashBtn');
    if (trashedVisible) {
        container.style.display = 'none';
        btn.innerHTML = '<i class="fa-solid fa-trash-can"></i> Show Trash';
        trashedVisible = false;
        return;
    }
    fetch('/api/v1/claude/' + encodeURIComponent(WORKTREE_NAME) + '/sessions/trash')
    .then(r => r.json())
    .then(data => {
        const sessions = data.data || data;
        const list = document.getElementById('trashedSessionsList');
        list.innerHTML = '';
        if (!sessions || sessions.length === 0) {
            list.innerHTML = '<p class="text-muted p-2">No trashed sessions.</p>';
        } else {
            sessions.forEach(s => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                const name = document.createElement('span');
                name.className = 'flex-grow-1';
                name.innerHTML = '<i class="fa-solid fa-message"></i> <span class="ms-1">' + escapeHtml(s.display_name) + '</span>';
                item.appendChild(name);
                const restoreBtn = document.createElement('button');
                restoreBtn.className = 'btn btn-outline-success btn-sm me-1';
                restoreBtn.innerHTML = '<i class="fa-solid fa-trash-arrow-up"></i>';
                restoreBtn.onclick = function() { restoreClaudeSession(s.id); };
                item.appendChild(restoreBtn);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-outline-danger btn-sm';
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteBtn.onclick = function() { permanentDeleteClaudeSession(s.id); };
                item.appendChild(deleteBtn);
                list.appendChild(item);
            });
        }
        container.style.display = 'block';
        btn.innerHTML = '<i class="fa-solid fa-trash-can"></i> Hide Trash';
        trashedVisible = true;
    })
    .catch(err => alert('Failed to load trashed sessions: ' + err));
}

function restoreClaudeSession(sessionId) {
    fetch('/api/v1/claude/sessions/' + sessionId + '/restore', { method: 'POST' })
    .then(() => window.location.reload())
    .catch(err => alert('Failed to restore session: ' + err));
}

function permanentDeleteClaudeSession(sessionId) {
    if (!confirm('Permanently delete this session? This cannot be undone.')) return;
    fetch('/api/v1/claude/sessions/' + sessionId + '/permanent', { method: 'DELETE' })
    .then(() => {
        if (trashedVisible) {
            toggleTrashedSessions();
            toggleTrashedSessions();
        }
    })
    .catch(err => alert('Failed to delete session: ' + err));
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function createTerminal() {
    const name = document.getElementById('terminalName').value.trim();
    const body = name ? JSON.stringify({name: name}) : '{}';
    fetch('/api/v1/terminal/' + encodeURIComponent(WORKTREE_NAME) + '/windows', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: body
    })
    .then(r => {
        if (!r.ok) return r.json().then(d => { throw new Error(d.error?.message || 'Create failed'); });
        return r.json();
    })
    .then(data => {
        const win = data.data || data;
        TrellisNav.pushToHistory(window.location.pathname);
        window.location.href = '/terminal/local/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(win.name);
    })
    .catch(err => alert('Failed to create terminal: ' + err));
}

function deleteTerminal(windowName) {
    if (!confirm('Delete terminal "' + windowName + '"?')) return;
    fetch('/api/v1/terminal/' + encodeURIComponent(WORKTREE_NAME) + '/windows/' + encodeURIComponent(windowName), {
        method: 'DELETE'
    })
    .then(() => window.location.reload())
    .catch(err => alert('Failed to delete terminal: ' + err));
}

function renameClaudeSession(sessionId, currentName) {
    document.getElementById('renameModalTitle').textContent = 'Rename Claude Session';
    document.getElementById('renameInput').value = currentName;
    renameConfirmCallback = function() {
        const newName = document.getElementById('renameInput').value.trim();
        if (!newName) return;
        fetch('/api/v1/claude/sessions/' + sessionId, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({display_name: newName})
        })
        .then(resp => {
            if (!resp.ok) throw new Error('rename failed');
            renameModal.hide();
            window.location.reload();
        })
        .catch(err => alert('Failed to rename session: ' + err));
    };
    renameModal.show();
}

function showImportTranscriptModal() {
    document.getElementById('transcriptFile').value = '';
    importTranscriptModal.show();
}

function importTranscript() {
    const fileInput = document.getElementById('transcriptFile');
    if (!fileInput.files.length) {
        alert('Please select a transcript file.');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        let transcript;
        try {
            transcript = JSON.parse(e.target.result);
        } catch (err) {
            alert('Invalid JSON file: ' + err);
            return;
        }
        fetch('/api/v1/claude/' + encodeURIComponent(WORKTREE_NAME) + '/sessions/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(transcript)
        })
        .then(r => {
            if (!r.ok) return r.json().then(d => { throw new Error(d.error?.message || 'Import failed'); });
            return r.json();
        })
        .then(data => {
            const sess = data.data || data;
            importTranscriptModal.hide();
            TrellisNav.pushToHistory(window.location.pathname);
            window.location.href = '/claude/' + encodeURIComponent(WORKTREE_NAME) + '/' + sess.id;
        })
        .catch(err => alert('Import failed: ' + err));
    };
    reader.readAsText(fileInput.files[0]);
}

function renameTerminal(currentName) {
    document.getElementById('renameModalTitle').textContent = 'Rename Terminal';
    document.getElementById('renameInput').value = currentName;
    renameConfirmCallback = function() {
        const newName = document.getElementById('renameInput').value.trim();
        if (!newName) return;
        fetch('/api/v1/terminal/' + encodeURIComponent(WORKTREE_NAME) + '/windows/' + encodeURIComponent(currentName), {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: newName})
        })
        .then(resp => {
            if (!resp.ok) throw new Error('rename failed');
            renameModal.hide();
            window.location.reload();
        })
        .catch(err => alert('Failed to rename terminal: ' + err));
    };
    renameModal.show();
}

function showNewCaseModal() {
    document.getElementById('caseTitle').value = '';
    document.getElementById('caseKind').value = 'task';
    newCaseModal.show();
}

function createCase() {
    const title = document.getElementById('caseTitle').value.trim();
    if (!title) { alert('Title is required'); return; }
    const kind = document.getElementById('caseKind').value;
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title: title, kind: kind})
    })
    .then(r => {
        if (!r.ok) return r.json().then(d => { throw new Error(d.error?.message || 'Create failed'); });
        return r.json();
    })
    .then(data => {
        const c = data.data || data;
        newCaseModal.hide();
        window.location.href = '/case/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(c.id);
    })
    .catch(err => alert('Failed to create case: ' + err));
}

function archiveCaseFromList(caseId) {
    if (!confirm('Archive this case?')) return;
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(caseId) + '/archive', {
        method: 'POST'
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Archive failed');
        window.location.reload();
    })
    .catch(err => alert('Archive failed: ' + err));
}

let archivedVisible = false;
function toggleArchivedCases() {
    const container = document.getElementById('archivedCasesContainer');
    const btn = document.getElementById('showArchivedBtn');
    if (archivedVisible) {
        container.style.display = 'none';
        btn.innerHTML = '<i class="fa-solid fa-box-archive"></i> Show Archived';
        archivedVisible = false;
        return;
    }
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/archived')
    .then(r => r.json())
    .then(data => {
        const cases = data.data || data;
        const list = document.getElementById('archivedCasesList');
        list.innerHTML = '';
        if (!cases || cases.length === 0) {
            list.innerHTML = '<p class="text-muted p-2">No archived cases.</p>';
        } else {
            cases.forEach(c => {
                const item = document.createElement('div');
                item.className = 'list-group-item case-list-item';
                item.innerHTML = '<div class="case-info">' +
                    '<a href="/case/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(c.id) + '" class="text-decoration-none">' +
                    '<span class="badge case-kind-' + c.kind + ' me-1">' + c.kind + '</span>' +
                    c.title + '</a>' +
                    '<span class="case-date">' + (c.created_at || '').substring(0, 10) + '</span></div>' +
                    '<button class="btn btn-outline-success btn-sm" onclick="reopenCaseFromList(\'' + c.id.replace(/'/g, "\\'") + '\')">' +
                    '<i class="fa-solid fa-box-open"></i></button>';
                list.appendChild(item);
            });
        }
        container.style.display = 'block';
        btn.innerHTML = '<i class="fa-solid fa-box-archive"></i> Hide Archived';
        archivedVisible = true;
    })
    .catch(err => alert('Failed to load archived cases: ' + err));
}

function reopenCaseFromList(caseId) {
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(caseId) + '/reopen', {
        method: 'POST'
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Reopen failed');
        window.location.reload();
    })
    .catch(err => alert('Reopen failed: ' + err));
}

</script>
<script src="/static/js/workflow_picker.js"></script>

{%= p.Footer() %}
{% endfunc %}
