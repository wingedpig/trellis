// Copyright Â© 2026 Groups.io, Inc.
// SPDX-License-Identifier: Apache-2.0

{% import "encoding/json" %}
{% import "github.com/wingedpig/trellis/internal/cases" %}
{% import "strings" %}

{% code
type CaseDetailPage struct {
    BasePage
    WorktreeName string
    Case         *cases.CaseJSON
    Notes        string
    Traces       []cases.CaseTraceSummary
}
%}

{% func (p *CaseDetailPage) Render() %}
{%= p.Header() %}

<link href="/static/css/cases.css" rel="stylesheet">

<div class="case-detail">
    <div class="case-header mb-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2>{%s p.Case.Title %}</h2>
                <div class="case-meta mt-2">
                    <span class="badge case-kind-{%s p.Case.Kind %}">{%s p.Case.Kind %}</span>
                    <span class="badge case-status-{%s p.Case.Status %}">{%s p.Case.Status %}</span>
                    <span class="text-muted ms-2">
                        <i class="fa-solid fa-calendar"></i> {%s p.Case.CreatedAt.Format("2006-01-02 15:04") %}
                    </span>
                    {% if !p.Case.UpdatedAt.Equal(p.Case.CreatedAt) %}
                    <span class="text-muted ms-2">
                        <i class="fa-solid fa-clock"></i> Updated {%s p.Case.UpdatedAt.Format("2006-01-02 15:04") %}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="case-actions">
                <a href="/worktree/{%s p.WorktreeName %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </a>
                {% if p.Case.Status != "archived" %}
                <button class="btn btn-outline-primary btn-sm" onclick="showWrapUpModal()">
                    <i class="fa-solid fa-flag-checkered"></i> Wrap Up
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="archiveCase()">
                    <i class="fa-solid fa-box-archive"></i> Archive
                </button>
                {% else %}
                <button class="btn btn-outline-success btn-sm" onclick="reopenCase()">
                    <i class="fa-solid fa-box-open"></i> Reopen
                </button>
                {% endif %}
                <button class="btn btn-outline-danger btn-sm" onclick="deleteCase()">
                    <i class="fa-solid fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <div class="case-section mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fa-solid fa-link"></i> Links</h4>
            <button class="btn btn-outline-secondary btn-sm" onclick="showAddLink()">
                <i class="fa-solid fa-plus"></i> Add
            </button>
        </div>
        <ul id="links-list" class="list-unstyled mt-2"></ul>
        <div id="link-add-form" class="case-link-add-form mt-2" style="display:none">
            <input type="text" id="link-title" class="form-control form-control-sm mb-2" placeholder="Title">
            <input type="url" id="link-url" class="form-control form-control-sm mb-2" placeholder="https://...">
            <div>
                <button class="btn btn-primary btn-sm" onclick="addLink()">
                    <i class="fa-solid fa-check"></i> Save
                </button>
                <button class="btn btn-outline-secondary btn-sm ms-1" onclick="cancelAddLink()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    {% if len(p.Case.Evidence) > 0 %}
    <div class="case-section mb-4">
        <h4><i class="fa-solid fa-file-lines"></i> Evidence</h4>
        <div class="list-group">
            {% for _, ev := range p.Case.Evidence %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>{%s ev.Title %}</strong>
                    <span class="badge bg-secondary ms-2">{%s ev.Format %}</span>
                    {% for _, tag := range ev.Tags %}
                    <span class="badge bg-info ms-1">{%s tag %}</span>
                    {% endfor %}
                </div>
                <span class="text-muted">{%s ev.AddedAt.Format("2006-01-02") %}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if len(p.Case.Claude) > 0 %}
    <div class="case-section mb-4">
        <h4><i class="fa-solid fa-robot"></i> Transcripts</h4>
        <div class="list-group">
            {% for _, ref := range p.Case.Claude %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <div>
                        <strong>{%s ref.Title %}</strong>
                        <span class="text-muted ms-2">{%d ref.MessageCount %} messages</span>
                        <span class="text-muted ms-2">{%s ref.ExportedAt.Format("2006-01-02 15:04") %}</span>
                        {% if ref.CurrentMessageCount > ref.MessageCount %}
                        <span class="text-warning ms-2" title="The live session has more messages than this saved transcript">
                            <i class="fa-solid fa-circle-exclamation"></i> {%d ref.CurrentMessageCount - ref.MessageCount %} new messages
                        </span>
                        {% elseif ref.CurrentMessageCount == -1 %}
                        <span class="text-muted ms-2" title="The source session has been deleted">
                            <i class="fa-solid fa-circle-xmark"></i> session deleted
                        </span>
                        {% endif %}
                    </div>
                    {% if ref.Preview != "" %}
                    <div class="text-muted small text-truncate" style="max-width: 600px;">{%s ref.Preview %}</div>
                    {% endif %}
                </div>
                <div class="d-flex gap-1">
                    {% if ref.CurrentMessageCount > ref.MessageCount %}
                    <button class="btn btn-outline-warning btn-sm" onclick="updateTranscript('{%s JSAttr(ref.ID) %}')" title="Update transcript with latest messages">
                        <i class="fa-solid fa-rotate"></i> Update
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-primary btn-sm" onclick="continueTranscript('{%s JSAttr(ref.ID) %}')">
                        <i class="fa-solid fa-play"></i> Continue
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if len(p.Traces) > 0 %}
    <div class="case-section mb-4">
        <h4><i class="fa-solid fa-magnifying-glass"></i> Traces</h4>
        <div class="list-group" id="traces-list">
            {% for _, tr := range p.Traces %}
            <div class="list-group-item d-flex justify-content-between align-items-center" id="trace-{%s tr.ID %}">
                <a href="/case/{%s p.WorktreeName %}/{%s p.Case.ID %}/trace/{%s tr.ID %}" class="text-decoration-none flex-grow-1">
                    <strong>{%s tr.Name %}</strong>
                    <span class="text-muted ms-2"><code>{%s tr.TraceID %}</code></span>
                    <span class="text-muted ms-2">{%s tr.Group %}</span>
                    <span class="text-muted ms-2">{%d tr.EntryCount %} entries</span>
                    <span class="text-muted ms-2">{%s tr.SavedAt.Format("2006-01-02 15:04") %}</span>
                </a>
                <button class="btn btn-outline-danger btn-sm ms-2" onclick="deleteTrace('{%s JSAttr(tr.ID) %}')" title="Remove trace">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="case-section mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fa-solid fa-note-sticky"></i> Notes</h4>
            <div id="notes-view-actions">
                <button class="btn btn-outline-secondary btn-sm" onclick="editNotes()">
                    <i class="fa-solid fa-pen"></i> Edit
                </button>
            </div>
            <div id="notes-edit-actions" style="display:none">
                <button class="btn btn-primary btn-sm" onclick="saveNotes()">
                    <i class="fa-solid fa-check"></i> Save
                </button>
                <button class="btn btn-outline-secondary btn-sm ms-1" onclick="cancelEditNotes()">
                    Cancel
                </button>
            </div>
        </div>
        <div id="notes-view" class="mt-2">
            <div id="case-notes" class="case-notes-content"></div>
        </div>
        <div id="notes-edit" class="mt-2" style="display:none">
            <textarea id="notes-textarea" class="case-notes-textarea"></textarea>
        </div>
    </div>
</div>

<script>
const WORKTREE_NAME = '{%s JSAttr(p.WorktreeName) %}';
const CASE_ID = '{%s JSAttr(p.Case.ID) %}';
let CASE_NOTES_RAW = {%s= notesJSONSafe(p.Notes) %};
let CASE_LINKS = {%s= linksJSONSafe(p.Case.Links) %};

document.addEventListener('DOMContentLoaded', function() {
    renderNotes();
    renderLinks();
});

function renderNotes() {
    var el = document.getElementById('case-notes');
    if (CASE_NOTES_RAW && typeof marked !== 'undefined') {
        el.innerHTML = marked.parse(CASE_NOTES_RAW);
        el.style.display = '';
    } else {
        el.innerHTML = '<span class="text-muted">No notes yet.</span>';
    }
}

function editNotes() {
    document.getElementById('notes-view').style.display = 'none';
    document.getElementById('notes-view-actions').style.display = 'none';
    document.getElementById('notes-edit').style.display = '';
    document.getElementById('notes-edit-actions').style.display = '';
    document.getElementById('notes-textarea').value = CASE_NOTES_RAW || '';
    document.getElementById('notes-textarea').focus();
}

function cancelEditNotes() {
    document.getElementById('notes-edit').style.display = 'none';
    document.getElementById('notes-edit-actions').style.display = 'none';
    document.getElementById('notes-view').style.display = '';
    document.getElementById('notes-view-actions').style.display = '';
}

function saveNotes() {
    var text = document.getElementById('notes-textarea').value;
    var btn = document.querySelector('#notes-edit-actions .btn-primary');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID), {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({notes: text})
    })
    .then(function(resp) {
        if (!resp.ok) throw new Error('Save failed');
        CASE_NOTES_RAW = text;
        renderNotes();
        cancelEditNotes();
    })
    .catch(function(err) { alert('Save failed: ' + err); })
    .finally(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Save';
    });
}

function renderLinks() {
    var el = document.getElementById('links-list');
    if (!CASE_LINKS || CASE_LINKS.length === 0) {
        el.innerHTML = '<li class="text-muted">No links yet.</li>';
        return;
    }
    el.innerHTML = CASE_LINKS.map(function(link, i) {
        return '<li class="case-link-item">' +
            '<a href="' + escapeAttr(link.url) + '" target="_blank" rel="noopener">' + escapeHTML(link.title) + '</a>' +
            '<button class="btn btn-outline-danger btn-sm case-link-delete" onclick="deleteLink(' + i + ')" title="Remove link">' +
            '<i class="fa-solid fa-xmark"></i></button>' +
            '</li>';
    }).join('');
}

function escapeHTML(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function escapeAttr(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML.replace(/"/g, '&quot;');
}

function showAddLink() {
    document.getElementById('link-add-form').style.display = '';
    document.getElementById('link-title').focus();
}

function cancelAddLink() {
    document.getElementById('link-add-form').style.display = 'none';
    document.getElementById('link-title').value = '';
    document.getElementById('link-url').value = '';
}

function addLink() {
    var title = document.getElementById('link-title').value.trim();
    var url = document.getElementById('link-url').value.trim();
    if (!title || !url) { alert('Title and URL are required.'); return; }
    CASE_LINKS.push({title: title, url: url});
    patchLinks()
        .then(function() { renderLinks(); cancelAddLink(); })
        .catch(function(err) { CASE_LINKS.pop(); alert('Save failed: ' + err); });
}

function deleteLink(index) {
    var removed = CASE_LINKS.splice(index, 1)[0];
    patchLinks()
        .then(function() { renderLinks(); })
        .catch(function(err) { CASE_LINKS.splice(index, 0, removed); alert('Delete failed: ' + err); });
}

function patchLinks() {
    return fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID), {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({links: CASE_LINKS})
    }).then(function(resp) {
        if (!resp.ok) throw new Error('Save failed');
    });
}

function archiveCase() {
    if (!confirm('Archive this case?')) return;
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID) + '/archive', {
        method: 'POST'
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Archive failed');
        window.location.href = '/worktree/' + encodeURIComponent(WORKTREE_NAME);
    })
    .catch(err => alert('Archive failed: ' + err));
}

function reopenCase() {
    if (!confirm('Reopen this case?')) return;
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID) + '/reopen', {
        method: 'POST'
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Reopen failed');
        window.location.reload();
    })
    .catch(err => alert('Reopen failed: ' + err));
}

function deleteCase() {
    if (!confirm('Permanently delete this case? This cannot be undone.')) return;
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID), {
        method: 'DELETE'
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Delete failed');
        window.location.href = '/worktree/' + encodeURIComponent(WORKTREE_NAME);
    })
    .catch(err => alert('Delete failed: ' + err));
}

function deleteTrace(traceId) {
    if (!confirm('Remove this trace from the case?')) return;
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID) + '/trace/' + encodeURIComponent(traceId), {
        method: 'DELETE'
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Delete failed');
        var el = document.getElementById('trace-' + traceId);
        if (el) el.remove();
    })
    .catch(err => alert('Delete failed: ' + err));
}

function updateTranscript(claudeId) {
    var btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID) + '/transcript/' + encodeURIComponent(claudeId), {
        method: 'PUT'
    })
    .then(resp => {
        if (!resp.ok) return resp.json().then(d => { throw new Error(d.error?.message || 'Update failed'); });
        window.location.reload();
    })
    .catch(err => {
        alert('Update failed: ' + err);
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Update';
    });
}

function continueTranscript(claudeId) {
    fetch('/api/v1/cases/' + encodeURIComponent(WORKTREE_NAME) + '/' + encodeURIComponent(CASE_ID) + '/transcript/' + encodeURIComponent(claudeId) + '/continue', {
        method: 'POST'
    })
    .then(r => {
        if (!r.ok) return r.json().then(d => { throw new Error(d.error?.message || 'Continue failed'); });
        return r.json();
    })
    .then(data => {
        const sess = data.data || data;
        window.location.href = '/claude/' + encodeURIComponent(WORKTREE_NAME) + '/' + sess.id;
    })
    .catch(err => alert('Continue failed: ' + err));
}
</script>

<script>
const WRAPUP_WORKTREE = WORKTREE_NAME;
const WRAPUP_SESSION_ID = null;
const WRAPUP_CASE = {id: CASE_ID, title: {%s= notesJSONSafe(p.Case.Title) %}, kind: '{%s p.Case.Kind %}'};
</script>

<!-- Wrap Up Modal -->
<div class="modal fade" id="wrapUpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-flag-checkered"></i> Wrap Up</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="wrapUpError" class="alert alert-danger" style="display:none"></div>
                <div id="wrapUpSuccess" class="alert alert-success" style="display:none"></div>

                <!-- Existing case info (read-only) -->
                <div id="wrapUpCaseInfo" style="display:none" class="mb-3">
                    <div class="card card-body bg-light">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-secondary" id="wrapUpCaseKind"></span>
                            <strong id="wrapUpCaseTitle"></strong>
                            <code class="ms-auto" id="wrapUpCaseId"></code>
                        </div>
                    </div>
                </div>

                <!-- New case fields (editable) -->
                <div id="wrapUpNewCase" style="display:none">
                    <div class="mb-3">
                        <label for="wrapUpNewTitle" class="form-label">Case Title</label>
                        <input type="text" class="form-control" id="wrapUpNewTitle" placeholder="Fix login bug" oninput="updateWrapUpCommitMsg()">
                    </div>
                    <div class="mb-3">
                        <label for="wrapUpNewKind" class="form-label">Kind</label>
                        <select class="form-select" id="wrapUpNewKind">
                            <option value="task">Task</option>
                            <option value="bug">Bug</option>
                            <option value="feature">Feature</option>
                            <option value="investigation">Investigation</option>
                        </select>
                    </div>
                </div>

                <!-- Files -->
                <div class="mb-3">
                    <label class="form-label">Files to commit</label>
                    <div id="wrapUpFileList" class="wrap-up-file-list"></div>
                </div>

                <!-- Commit message -->
                <div class="mb-3">
                    <label for="wrapUpCommitMsg" class="form-label">Commit message</label>
                    <textarea class="form-control" id="wrapUpCommitMsg" rows="3"></textarea>
                </div>

                <!-- Links -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">Links (optional)</label>
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="addWrapUpLink()">
                            <i class="fa-solid fa-plus"></i> Add
                        </button>
                    </div>
                    <div id="wrapUpLinks"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="wrapUpConfirmBtn" onclick="wrapUpConfirm()">
                    <i class="fa-solid fa-flag-checkered"></i> Wrap Up
                </button>
            </div>
        </div>
    </div>
</div>

<link href="/static/css/claude.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
<script src="/static/js/wrapup.js"></script>
<script src="/static/js/workflow_picker.js"></script>

{%= p.Footer() %}
{% endfunc %}

{% code
// notesJSONSafe returns the notes as a JSON-encoded string safe for embedding in a <script> tag.
func notesJSONSafe(s string) string {
    // JSON encode the string (handles escaping quotes, newlines, etc.)
    b, _ := json.Marshal(s)
    // Replace </script to prevent XSS
    result := strings.ReplaceAll(string(b), "</", "<\\/")
    return result
}

// linksJSONSafe returns the links slice as a JSON array safe for embedding in a <script> tag.
func linksJSONSafe(links []cases.CaseLink) string {
    if links == nil {
        return "[]"
    }
    b, _ := json.Marshal(links)
    result := strings.ReplaceAll(string(b), "</", "<\\/")
    return result
}
%}
